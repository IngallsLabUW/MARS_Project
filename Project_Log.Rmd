---
title: "MARS Project Log"
author: "RLionheart"
date: "10/22/2020"
output:
  html_document: default
  pdf_document: default
---

### MARS Project Log

- In the getMetlinName function, it looks like the output of exact_mass is already accounting for the proton weight. So only need it for MoNA?
- Still need to get msms for metlin up and running, but not crucial.

- Fragment matching: % of library sample found in fragments. 
    Example, experimental spectra has *110.97466, 100;* 110.03485, 39.1; *58.02862, 33.5;* 68.01299, 26.6; 111.01888, 20.6.
    Library spectra has               *110.97466, 100;* 109.00000, 40.1; *58.02862, 33.5;* 70.33989, 26.6; 121.04950, 15.0.
    If the above two lines were identical, the fragment match would be 100%. In this situation, the fragment match would be 40% or 0.4.
- Having some RT similarity calculation problems. Answers tend to be 0, nearly 0, or infinity.
---

This is an ongoing log: a place for build notes and questions.
*This is not to be confused with the Design Doc on the Shared Google Drive; that is for overall design direction and team suggestions. It is also not a README, which will be written closer to project completion.*

What is being worked on right now

Streamlining the process for import and standards-related ID.
1. Standard import file with feature, mz, rt, column, z, and ms2
*Confidence Level 1*

- Use [FuzzyJoin](http://varianceexplained.org/fuzzyjoin/) to match m/z, rt, column, and z for positive IDs and return a dataframe of matches. 

*Similarity Score*

- For the overall spectral similarity score, a combination of several equations from KRH and Tsugawa et. al form a total similarity equation for scoring.

*Confidence Level 2*

- Match unknown experimental values to MoNA and Metlin dataframes (which will be updated either every quarter, or as often as necessary). 

MoNA: Bare bones run complete
Metlin: in progress

- Only for mass features that have MS2 (otherwise not eligible for "level 2" confidence match.

*Confidence Level 3*
KEGG: in progress


#### Ongoing issues
Issues that will need to be fixed

- see where KRH and MARS identification differ
- Incorporate existing KRH code to easily update the standards MS2 data (including MS2 standardization step).
- Decide on order of matching parameters: column, z, mz, rt, ms2? 
- Set up flexible equation for Total.Similarity score.
- The dataframes to be annotated are from a variety of sources (xcms, MSDIAL), and are presented in a variety of formats and curation levels. Input will need to be standardized.
- Need to replace old compound names with new ones!
- For now, using given tolerance values is fine, but eventually we should be calculating it from the fuzzyjoin tolerance *clarify this later with KRH*.
- For now, we can compare to our own spectra and use 0.02 as tolerance. Revisit later to make it into ppm space.
- Incorporate the existing Metlin scraping structure into a database that will grow with each successive scrape.
- Run through the KEGG matching functions. 
- Tidy and rename variables in nearly all steps.

#### Other notes
- Remember, you can get the score w/out MS2! The eventual full function should be able to do both.
- Will can make an MS2 library for stds
- Potential change for rt times to nano energy
- For DDA high resolution, the mass spec sees a high signal. When it see that, it takes above and below that signal and isolates it in the collision chamber. In the ms2 df, the first column is the exact mass with an intensity of 100 (maximum), then second mass and intensity, etc. 
- Moving to rank 3: currently nothing exists for HMDB Poke around the website. Might be connected to MoNA. Will is going to send some stuff for PubMed, but it's a huge download that may not be worth it. Try everything else first.
- Output should be relational, or a complete csv depending on who's looking/filtering. Wrapper in package should account for that. ie, how many matches come up and where are they from?
- "known" mzs and rts will be from standards sheet. maybe later can factor in the ms2 info, but mzs are very similar and rts will require CE consideration.
