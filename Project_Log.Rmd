---
title: "MARS Project Log"
author: "RLionheart"
date: "10/22/2020"
output:
  html_document: default
  pdf_document: default
---


### MARS Project Log

This is an ongoing log: a place for build notes and questions.
*This is not to be confused with the Design Doc on the Shared Google Drive; that is for overall design direction and team suggestions. It is also not a README, which will be written closer to project completion.*



#### Comments and questions for December 8 
- "From literature" ranking stats: I have in my notes that this can wait until later. That still the case or would we like to prioritize rounding off ranking level 2?
- Review Metlin status: no base sheet exists but we should be able to get there with time.
- MoNA matching: It's working, but not well. mclapply seems like a logical choice but debugging is very challenging, unless I can figure out how to use it in a reasonable time frame I will move on to a different option. Suggestions welcome but I would strongly prefer not to use plyr. Biome cparallel is an option. 
- Moving to rank 3: I have the KEGG functions from KRH and am starting to work through those. Katherine mentioned HMDB in the design doc, does anything already exist for that? I don't see it in the original functions sheet. Ditto for PubMed.
- can I give an update on this to the lab before xmas? Will we be meeting that week? 

#### TODO: 
What is being worked on right now

- Match experimental unknowns with MoNA dataframes and parallelize that.
- Incorporate the existing Metlin scraping structure into a database that will grow with each successive scrape.

New standards MS2: It's actually 12 total injections for pos and 12 for neg since we have two different standard mixes. 

*Confidence Level 1*

- Use [FuzzyJoin](http://varianceexplained.org/fuzzyjoin/) to match m/z, rt, column, and z for positive IDs and return a dataframe of matches. 

*Similarity Score*

- For the overall spectral similarity score, a combination of several equations from KRH and Tsugawa et. al form a total similarity equation for scoring.

*Confidence Level 2*

- Match unknown experimental values to MoNA and Metlin dataframes (which will be updated either every quarter, or as often as necessary). 

MoNA:

- Only for mass features that have MS2 (otherwise not eligible for "level 2" confidence match.



#### Ongoing issues
Issues that will need to be fixed eventually

- Transform MS2 from MSP --> standards list in the KRH spectral format.
  + This step will require cleaning, including but not limited to no intensities below 1 (throw out all those tiny fragment spectra), scale intensity so the biggest value is 100, and then order by descending intensity. intensity needs to be descending and scaled so the biggest value is 100.
- Tidy up the workflow of the mz/rt/ms2/z/column dataframe to a Confidence Level 1 annotated dataframe.
- Set up flexible equation for Total.Similarity score.
- The dataframes to be annotated are from a variety of sources (xcms, MSDIAL), and are presented in a variety of formats and curation levels.
- Input will need to be standardized, through the annotation functions. Eventually that script/function process will be part of the R package. 
- "w/o MS2:" on identified compounds is from MSDIAL output and currently isn't matching that we should rely on.
- Need to replace old compound names with new ones! Will work on that later.
- Need to reliably translate msp files for incorporation. KRH has a json translation but not msp. 
- Also we stds list, but we don't know the collision energy. 
- Make a function to investigate which columns are only NULL.
- For now, using given tolerance values is fine, but eventually we should be calculating it from the fuzzyjoin tolerance *clarify this later with KRH*.
- For now, we can compare to our own spectra and use 0.02 as tolerance. Revisit later to make it into ppm space.
- Need to ensure both positive and negative functions/dataframes are all up to scratch. 


#### Other notes
- Remember, you can get the score w/out MS2! The eventual full function should be able to do both.
- Will can make an MS2 library for stds
- Naming schemes are all different for unique mass features
- Potential change for rt times to nano energy
- Spectra are relative abundances.
- For DDA high resolution, the mass spec sees a high signal. When it see that, it takes above and below that signal and isolates it in the collision chamber. In the ms2 df, the first column is the exact mass with an intensity of 100 (maximum), then second mass and intensity, etc. 
